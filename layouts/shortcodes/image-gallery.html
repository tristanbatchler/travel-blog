{{- $folder := .Get "folder" -}}
{{- $caption := .Get "caption" | default "" -}}
{{- $class := "gallery-regular" -}}
{{- if in $folder "-part-" }}{{ $class = "gallery-continuation" }}{{ end }}
{{- $page := .Page -}}

{{- $images := ($page.Resources.Match (printf "%s/*" $folder)) -}}
{{- $sorted := sort $images "Name" -}}

{{- /* Filter out .mp4 files that have a .webm sibling */ -}}
{{- $filtered := slice -}}
{{- range $sorted -}}
  {{- $ext := lower (path.Ext .Name) -}}
  {{- if eq $ext ".mp4" -}}
    {{- $basename := replace (path.Base .Name) $ext "" -}}
    {{- $webm := $page.Resources.GetMatch (printf "%s/%s.webm" $folder $basename) -}}
    {{- if not $webm -}}
      {{- $filtered = $filtered | append . -}}
    {{- end -}}
  {{- else -}}
    {{- $filtered = $filtered | append . -}}
  {{- end -}}
{{- end -}}

{{- $count := len $filtered -}}
{{- if gt $count 0 -}}
  {{- $sumAspect := float 0 -}}
  {{- range $filtered -}}
    {{- $ext := lower (path.Ext .Name) -}}
    {{- if in (slice ".jpg" ".jpeg" ".png" ".gif") $ext -}}
      {{- $w := float .Width -}}
      {{- $h := float .Height -}}
      {{- if or (eq $w 0) (eq $h 0) -}}
        {{- $thumb := .Resize "800x" -}}
        {{- $w = float $thumb.Width -}}
        {{- $h = float $thumb.Height -}}
      {{- end -}}
      {{- if gt $h 0 -}}
        {{- $sumAspect = add $sumAspect (div $w $h) -}}
      {{- end -}}
    {{- else if in (slice ".webm" ".mp4") $ext -}}
      {{- $basename := replace (path.Base .Name) $ext "" -}}
      {{- $dims := split (index (split (index (last 1 (split .Name "-")) 0) ".") 0) "x" }}
      {{- $w := index $dims 0 }}
      {{- $h := index $dims 1 }}
      {{- if and $w $h -}}
        {{- $w = float $w -}}
        {{- $h = float $h -}}
        {{- if gt $h 0 -}}
          {{- $sumAspect = add $sumAspect (div $w $h) -}}
        {{- end -}}
      {{- else -}}
        {{- $sumAspect = add $sumAspect (div (float 16) (float 9)) -}}
      {{- end -}}
    {{- else -}}
      {{- $sumAspect = add $sumAspect (div (float 16) (float 9)) -}}
    {{- end -}}
  {{- end -}}

  {{- $gapPerItem := 10 -}}
  {{- $extra := mul $count $gapPerItem -}}
  {{- $maxH := 300 -}}
  {{- $galleryWFloat := add (mul $sumAspect (float $maxH)) (float $extra) -}}
  {{- $galleryW := int $galleryWFloat -}}

  <ul class="image-gallery {{ $class }}" style="aspect-ratio: {{ $galleryW }} / {{ $maxH }}; max-height: {{ $maxH }}px;">
    {{- range $filtered -}}
      {{- $ext := lower (path.Ext .Name) -}}
      <li>
        {{- if in (slice ".jpg" ".jpeg" ".png") $ext }}
          {{- $thumb := .Resize "800x" -}}
          <img src="{{ $thumb.RelPermalink }}" data-zoom-src="{{ .RelPermalink }}" loading="lazy" alt="{{ .Name }}">
        {{- else if eq ".gif" $ext }}
          <img src="{{ .RelPermalink }}" data-zoom-src="{{ .RelPermalink }}" loading="lazy" alt="{{ .Name }}">
        {{- else if eq ".webm" $ext }}
          {{- $basename := replace (path.Base .Name) $ext "" -}}
          {{- $mp4 := $page.Resources.GetMatch (printf "%s/%s.mp4" $folder $basename) -}}
          <video autoplay loop muted playsinline>
            <source src="{{ .RelPermalink }}" type="video/webm">
            {{- if $mp4 }}
            <source src="{{ $mp4.RelPermalink }}" type="video/mp4">
            {{- end }}
            Your browser does not support the video tag.
          </video>
        {{- else if eq ".mp4" $ext }}
          <video autoplay loop muted playsinline>
            <source src="{{ .RelPermalink }}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        {{- end }}
        {{- if $caption }}
          <span class="gallery-caption">{{ $caption }}</span>
        {{- end }}
      </li>
    {{- end }}
  </ul>
{{- end -}}